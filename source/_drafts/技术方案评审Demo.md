---
title: 技术方案评审Demo
tags:
---
> 以人人点评二期为样本，编写本Demo

## 业务背景
度假业务的订单点评，同时有出游人点评和预订人点评两种业务场景，我们统称为人人点评。 
本次调整有两个背景： 
- 以前由于在境外获取短信失败率高的原因，所以需要在出游前发送给所有人点评验证码
- 周边跟团则会由导游领队在回程大巴上让游客扫码点评，导致好评率虚高 

故业务调整策略：
- 点评时间调整为最早回团后第二天0点
- 所有人人点评的验证方式都改成实时通过手机号获取验证码 

## 调整后的业务流程 
- 预订人：从各渠道的订单列表或订单详情页直接进入点评页（需要验证用户登录状态） 
- 出游人：通过扫码人人点评验证页面的二维码或者短信通知链接进入验证（链接上可能会带有订单号），验证通过后接口返回可点评的订单列表，用户选择某个订单后（如果是链接上直接带了订单号的，直接匹配）进入写点评页（该场景下无需验证用户登录状态）

## 本次任务涉及到的页面及异步接口
该流程仅涉及H5类渠道 ，以下表格中的路由未包含项目二级目录，出境为/dujia/newoc/

|名称|类型|路由|请求方式|
| -------- | -------- | -------- | -------- |
|验证页|同步页面|/comment/verify/|get|
|获取短信验证码|异步接口|/comment/mobilecode/|get|
|验证提交|异步接口|/comment/verify/|post|
|写点评页|同步页面|/comment/|get|

## 核心流程
### 获取点评验证码防刷
- 加入设备指纹拦截
- 设计一套token机制（可选项）

### 对于带了订单号的验证页链接，在服务端直接判断订单是否匹配，而不再返回所有可点评订单
### 写点评页安全验证
- 从验证页跳转过来时，带一个token，该token在服务端提前生成好并存入redis，进入写点评页后先根据token从服务端取出相应值，判断订单号是否匹配
- 如果没有带token，则判断登录memberId是否匹配订单中的memberId

## 附加优化
- api站点评相关方法，统一收口到api.controller/allin/comment.js
- 清理web站controller多余方法
- api站controller继承于base.js